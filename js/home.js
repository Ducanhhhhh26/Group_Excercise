let musicData = {
  played: [
    { id: "1", title: "Endless Summer", artist: "Sarah Johnson", image: "../assets/images/img_2.png", mp3: "https://samplesongs.netlify.app/Death%20Bed.mp3" },
    { id: "2", title: "Midnight Dreams", artist: "Alex Turner", image: "../assets/images/img_3.png", mp3: "https://samplesongs.netlify.app/Death%20Bed.mp3" },
    { id: "3", title: "Neon Lights", artist: "Electro Beats", image: "../assets/images/img_4.png", mp3: "https://samplesongs.netlify.app/Death%20Bed.mp3" },
    { id: "4", title: "Mountain View", artist: "Nature Sounds", image: "../assets/images/img_5.png", mp3: "https://samplesongs.netlify.app/Death%20Bed.mp3" },
    { id: "5", title: "City Lights", artist: "Urban Rhythms", image: "../assets/images/img_6.png", mp3: "https://samplesongs.netlify.app/Death%20Bed.mp3" },
    { id: "6", title: "Ocean Waves", artist: "Coastal Sounds", image: "../assets/images/img_7.png", mp3: "https://samplesongs.netlify.app/Death%20Bed.mp3" },
    { id: "7", title: "Bloodlust", artist: "Ava Cornish & Brian Hill", image: "../assets/images/song1.jpg.png", mp3: "https://samplesongs.netlify.app/Death%20Bed.mp3" },
    { id: "8", title: "Time flies", artist: "Ava Cornish & Brian Hill", image: "../assets/images/song5.jpg.png", mp3: "https://samplesongs.netlify.app/Death%20Bed.mp3" },
    { id: "9", title: "Dark matters", artist: "Ava Cornish & Brian Hill", image: "../assets/images/song6.jpg.png", mp3: "https://samplesongs.netlify.app/Death%20Bed.mp3" },
    { id: "10", title: "Eye to eye", artist: "Ava Cornish & Brian Hill", image: "../assets/images/song1.jpg.png", mp3: "https://samplesongs.netlify.app/Death%20Bed.mp3" },
    { id: "11", title: "Cloud nine", artist: "Ava Cornish & Brian Hill", image: "../assets/images/song3.jpg.png", mp3: "https://samplesongs.netlify.app/Death%20Bed.mp3" },
    { id: "12", title: "Cobweb of lies", artist: "Ava Cornish & Brian Hill", image: "../assets/images/song5.jpg.png", mp3: "https://samplesongs.netlify.app/Death%20Bed.mp3" }
  ],
  top15: [
    { id: "1", title: "Summer Vibes", artist: "Beach Boys", image: "../assets/images/img_10.png", mp3: "https://samplesongs.netlify.app/Death%20Bed.mp3" },
    { id: "2", title: "Moonlit Nights", artist: "Luna Echo", image: "../assets/images/img_11.png", mp3: "https://samplesongs.netlify.app/Death%20Bed.mp3" },
    { id: "3", title: "Electric Pulse", artist: "DJ Spark", image: "../assets/images/img_12.png", mp3: "https://samplesongs.netlify.app/Death%20Bed.mp3" },
    { id: "4", title: "Golden Hour", artist: "Sunny Days", image: "../assets/images/img_13.png", mp3: "https://samplesongs.netlify.app/Death%20Bed.mp3" },
    { id: "5", title: "Echoes of Love", artist: "Heartstrings", image: "../assets/images/img_14.png", mp3: "https://samplesongs.netlify.app/Death%20Bed.mp3" },
    { id: "6", title: "City Dreams", artist: "Urban Echo", image: "../assets/images/img_15.png", mp3: "https://samplesongs.netlify.app/Death%20Bed.mp3" },
    { id: "7", title: "Starry Sky", artist: "Night Glow", image: "../assets/images/img_16.png", mp3: "https://samplesongs.netlify.app/Death%20Bed.mp3" },
    { id: "8", title: "Rhythm Flow", artist: "Beat Master", image: "../assets/images/img_17.png", mp3: "https://samplesongs.netlify.app/Death%20Bed.mp3" },
    { id: "9", title: "Ocean Breeze", artist: "Wave Riders", image: "../assets/images/img_18.png", mp3: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3" },
    { id: "10", title: "Sunset Glow", artist: "Horizon Band", image: "../assets/images/img_14.png", mp3: "https://samplesongs.netlify.app/Death%20Bed.mp3" },
    { id: "11", title: "Neon Dreams", artist: "Light Pulse", image: "../assets/images/img_17.png", mp3: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-7.mp3" },
    { id: "12", title: "Wild Hearts", artist: "Free Spirits", image: "../assets/images/img_10.png", mp3: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3" },
    { id: "13", title: "Crystal Echo", artist: "Glass Notes", image: "../assets/images/img_16.png", mp3: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-9.mp3" },
    { id: "14", title: "Frosty Nights", artist: "Winter Chill", image: "../assets/images/img_19.png", mp3: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-10.mp3" },
    { id: "15", title: "Fire Within", artist: "Blaze Band", image: "../assets/images/img_15.png", mp3: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-11.mp3" }
  ],
  artist: [
    { id: "1", title: "Endless Summer", artist: "Sarah Johnson", image: "../assets/images/img_2.png", mp3: "https://samplesongs.netlify.app/Death%20Bed.mp3" },
    { id: "2", title: "Midnight Dreams", artist: "Alex Turner", image: "../assets/images/img_3.png", mp3: "https://samplesongs.netlify.app/Death%20Bed.mp3" },
    { id: "3", title: "Neon Lights", artist: "Electro Beats", image: "../assets/images/img_4.png", mp3: "https://samplesongs.netlify.app/Death%20Bed.mp3" },
    { id: "4", title: "Mountain View", artist: "Nature Sounds", image: "../assets/images/img_5.png", mp3: "https://samplesongs.netlify.app/Death%20Bed.mp3" },
    { id: "5", title: "City Lights", artist: "Urban Rhythms", image: "../assets/images/img_6.png", mp3: "https://samplesongs.netlify.app/Death%20Bed.mp3" },
    { id: "6", title: "Ocean Waves", artist: "Coastal Sounds", image: "../assets/images/img_7.png", mp3: "https://samplesongs.netlify.app/Death%20Bed.mp3" },
    { id: "7", title: "Bloodlust", artist: "Ava Cornish & Brian Hill", image: "../assets/images/song1.jpg.png", mp3: "https://samplesongs.netlify.app/Death%20Bed.mp3" },
    { id: "8", title: "Time flies", artist: "Ava Cornish & Brian Hill", image: "../assets/images/song5.jpg.png", mp3: "https://samplesongs.netlify.app/Death%20Bed.mp3" },
    { id: "9", title: "Dark matters", artist: "Ava Cornish & Brian Hill", image: "../assets/images/song6.jpg.png", mp3: "https://samplesongs.netlify.app/Death%20Bed.mp3" },
    { id: "10", title: "Eye to eye", artist: "Ava Cornish & Brian Hill", image: "../assets/images/song1.jpg.png", mp3: "https://samplesongs.netlify.app/Death%20Bed.mp3" },
    { id: "11", title: "Cloud nine", artist: "Ava Cornish & Brian Hill", image: "../assets/images/song3.jpg.png", mp3: "https://samplesongs.netlify.app/Death%20Bed.mp3" },
    { id: "12", title: "Cobweb of lies", artist: "Ava Cornish & Brian Hill", image: "../assets/images/song5.jpg.png", mp3: "https://samplesongs.netlify.app/Death%20Bed.mp3" }
  ],
  releases: [
    { title: "Dark Alley Acoustic", artist: "Ava Cornish", image: "../assets/images/img_14.png", duration: "5:10", mp3: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-12.mp3" },
    { title: "Dreamy Nights", artist: "Luna Echo", image: "../assets/images/img_16.png", duration: "4:30", mp3: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-13.mp3" },
    { title: "Electric Vibes", artist: "DJ Spark", image: "../assets/images/img_11.png", duration: "3:45", mp3: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-14.mp3" },
    { title: "Golden Sunset", artist: "Sunny Days", image: "../assets/images/img_15.png", duration: "4:15", mp3: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-15.mp3" }
  ],
  albums: [
    { id: "1", title: "Endless Summer", artist: "Sarah Johnson", image: "../assets/images/img_2.png", mp3: "https://samplesongs.netlify.app/Death%20Bed.mp3" },
    { id: "2", title: "Midnight Dreams", artist: "Alex Turner", image: "../assets/images/img_3.png", mp3: "https://samplesongs.netlify.app/Death%20Bed.mp3" },
    { id: "3", title: "Neon Lights", artist: "Electro Beats", image: "../assets/images/img_4.png", mp3: "https://samplesongs.netlify.app/Death%20Bed.mp3" },
    { id: "4", title: "Mountain View", artist: "Nature Sounds", image: "../assets/images/img_5.png", mp3: "https://samplesongs.netlify.app/Death%20Bed.mp3" },
    { id: "5", title: "City Lights", artist: "Urban Rhythms", image: "../assets/images/img_6.png", mp3: "https://samplesongs.netlify.app/Death%20Bed.mp3" },
    { id: "6", title: "Ocean Waves", artist: "Coastal Sounds", image: "../assets/images/img_7.png", mp3: "https://samplesongs.netlify.app/Death%20Bed.mp3" },
    { id: "7", title: "Bloodlust", artist: "Ava Cornish & Brian Hill", image: "../assets/images/song1.jpg.png", mp3: "https://samplesongs.netlify.app/Death%20Bed.mp3" },
    { id: "8", title: "Time flies", artist: "Ava Cornish & Brian Hill", image: "../assets/images/song5.jpg.png", mp3: "https://samplesongs.netlify.app/Death%20Bed.mp3" },
    { id: "9", title: "Dark matters", artist: "Ava Cornish & Brian Hill", image: "../assets/images/song6.jpg.png", mp3: "https://samplesongs.netlify.app/Death%20Bed.mp3" },
    { id: "10", title: "Eye to eye", artist: "Ava Cornish & Brian Hill", image: "../assets/images/song1.jpg.png", mp3: "https://samplesongs.netlify.app/Death%20Bed.mp3" },
    { id: "11", title: "Cloud nine", artist: "Ava Cornish & Brian Hill", image: "../assets/images/song3.jpg.png", mp3: "https://samplesongs.netlify.app/Death%20Bed.mp3" },
    { id: "12", title: "Cobweb of lies", artist: "Ava Cornish & Brian Hill", image: "../assets/images/song5.jpg.png", mp3: "https://samplesongs.netlify.app/Death%20Bed.mp3" }
  ]
};

// Khởi tạo danh sách tài khoản tĩnh với admin mặc định
let accounts = [
  {
    accountId: "TK000001",
    fullName: "Admin User",
    email: "admin@example.com",
    password: "Admin@123",
    dob: "01/01/1990",
    phone: "0123456789",
    hometown: "Hà Nội",
    role: "Admin"
  }
];
let currentUser = null;

document.addEventListener("DOMContentLoaded", () => {
  // Chọn các phần tử DOM
  const searchInput = document.querySelector(".search-input");
  const searchBtn = document.querySelector(".search-btn");
  const clearBtn = document.querySelector(".clear-btn");
  const searchMessage = document.querySelector(".search-message");
  const recentlyPlayedGrid = document.querySelector(".recently-played .album-grid");
  const chartsGrid = document.querySelector(".charts-section .charts-grid");
  const releasesContainer = document.querySelector(".releases");
  const featuredArtistsGrid = document.querySelector(".featured-artists .album-grid");
  const featuredAlbumsGrid = document.querySelector(".featured-albums .album-grid");
  const sidebar = document.querySelector(".sidebar");
  const chevronBtn = document.querySelector(".sidebar-chevorn a");
  const mainContent = document.querySelector(".container");
  const header = document.querySelector("header");
  const modalLogin = document.querySelector(".modalLogin");
  const loginForm = document.querySelector(".formLogin");
  const forgotPasswordLink = document.querySelector(".forgot-password");
  const registerLink = document.querySelector(".formLogin .register-link");
  const modalRegister = document.querySelector(".modalRegister");
  const registerForm = document.querySelector(".formRegister");
  const loginLink = document.querySelector(".formRegister .login-link");
  const audioPlayer = document.getElementById("audio-player");
  const playBtn = document.querySelector(".play-btn");
  const skipBackwardBtn = document.querySelector(".skip-backward-btn");
  const skipForwardBtn = document.querySelector(".skip-forward-btn");
  const muteBtn = document.querySelector(".mute-btn");
  const playerAlbumImg = document.querySelector(".player-album-img img");
  const playerSongTitle = document.querySelector(".player-song-info h6");
  const playerSongArtist = document.querySelector(".player-song-info p");

  // Khởi tạo trạng thái trình phát
  let isPlaying = false;
  let isMuted = false;
  let currentSongIndex = -1;
  let currentPlaylist = musicData.albums;
  let playlistType = "albums";

  // Chức năng tìm kiếm
  if (searchInput && clearBtn && searchMessage && searchBtn) {
    searchInput.addEventListener("input", () => {
      clearBtn.style.display = searchInput.value ? "block" : "none";
    });

    searchBtn.addEventListener("click", () => {
      const query = searchInput.value.toLowerCase().trim();
      filterContent(query);
    });

    clearBtn.addEventListener("click", () => {
      searchInput.value = "";
      clearBtn.style.display = "none";
      searchMessage.style.display = "none";
      filterContent("");
    });
  }

  function filterContent(query) {
    const albumItems = musicData.albums.filter(
      (item) =>
        query === "" ||
        item.title.toLowerCase().includes(query) ||
        item.artist.toLowerCase().includes(query)
    );
    const renderAlbumGrid = (grid, items, maxItems = items.length) => {
      if (grid) {
        grid.innerHTML = items
          .slice(0, maxItems)
          .map(
            (item, index) => `
              <div class="album-item" data-index="${index}">
                <img src="${item.image}" alt="Album Cover">
                <div class="album-info">
                  <div class="album-title">${item.title}</div>
                  <div class="album-artist">${item.artist}</div>
                </div>
              </div>
            `
          )
          .join("");
      }
    };

    renderAlbumGrid(recentlyPlayedGrid, albumItems, 11);
    renderAlbumGrid(featuredArtistsGrid, albumItems, 6);
    renderAlbumGrid(featuredAlbumsGrid, albumItems, 7);

    const chartItems = musicData.top15.filter(
      (item) =>
        query === "" ||
        item.title.toLowerCase().includes(query) ||
        item.artist.toLowerCase().includes(query)
    );
    if (chartsGrid) {
      chartsGrid.innerHTML = `
        <div class="chart-column">
          ${chartItems
            .slice(0, 5)
            .map(
              (item, index) => `
                <div class="chart-item" data-index="${index}">
                  <div class="chart-number">${(index + 1)
                    .toString()
                    .padStart(2, "0")}</div>
                  <div class="chart-thumbnail">
                    <img src="${item.image}" alt="Song Thumbnail">
                  </div>
                  <div class="chart-info">
                    <div class="chart-title">${item.title}</div>
                    <div class="chart-artist">${item.artist}</div>
                  </div>
                  <div class="chart-buttons">
                    <button><i class="fas fa-play"></i></button>
                  </div>
                </div>
              `
            )
            .join("")}
        </div>
        <div class="chart-column">
          ${chartItems
            .slice(5, 10)
            .map(
              (item, index) => `
                <div class="chart-item" data-index="${index + 5}">
                  <div class="chart-number">${(index + 6)
                    .toString()
                    .padStart(2, "0")}</div>
                  <div class="chart-thumbnail">
                    <img src="${item.image}" alt="Song Thumbnail">
                  </div>
                  <div class="chart-info">
                    <div class="chart-title">${item.title}</div>
                    <div class="chart-artist">${item.artist}</div>
                  </div>
                  <div class="chart-buttons">
                    <button><i class="fas fa-play"></i></button>
                  </div>
                </div>
              `
            )
            .join("")}
        </div>
        <div class="chart-column">
          ${chartItems
            .slice(10, 15)
            .map(
              (item, index) => `
                <div class="chart-item" data-index="${index + 10}">
                  <div class="chart-number">${(index + 11)
                    .toString()
                    .padStart(2, "0")}</div>
                  <div class="chart-thumbnail">
                    <img src="${item.image}" alt="Song Thumbnail">
                  </div>
                  <div class="chart-info">
                    <div class="chart-title">${item.title}</div>
                    <div class="chart-artist">${item.artist}</div>
                  </div>
                  <div class="chart-buttons">
                    <button><i class="fas fa-play"></i></button>
                  </div>
                </div>
              `
            )
            .join("")}
        </div>
      `;
    }

    if (searchMessage) {
      searchMessage.style.display =
        albumItems.length === 0 && chartItems.length === 0 && query !== ""
          ? "block"
          : "none";
      searchMessage.textContent =
        query !== "" && (albumItems.length === 0 && chartItems.length === 0)
          ? "Không tìm thấy kết quả."
          : "";
    }
  }

  // Chức năng xác thực người dùng
  function updateAuthButtons() {
    let loginBtn = document.querySelector(".login-btn");
    const registerBtn = document.querySelector(".register-btn");

    if (currentUser) {
      if (registerBtn) registerBtn.style.display = "none";
      if (loginBtn) {
        loginBtn.textContent = "Log out";
        loginBtn.classList.remove("login-btn");
        loginBtn.classList.add("logout-btn");
        const newLoginBtn = loginBtn.cloneNode(true);
        loginBtn.parentNode.replaceChild(newLoginBtn, loginBtn);
        newLoginBtn.addEventListener("click", () => {
          Swal.fire({
            title: "Are you sure?",
            text: "You will be logged out of your account.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Yes, log out",
            cancelButtonText: "Cancel",
          }).then((result) => {
            if (result.isConfirmed) {
              currentUser = null;
              Swal.fire(
                "Logged out!",
                "You have been successfully logged out.",
                "success"
              );
              updateAuthButtons();
              filterContent("");
            }
          });
        });
      }
      const welcomeMessage = document.createElement("span");
      welcomeMessage.className = "me-2";
      welcomeMessage.textContent = `Chào, ${currentUser.fullName}`;
      const authContainer = document.querySelector(
        "header .d-flex.align-items-center > div:last-child"
      );
      if (authContainer && !authContainer.querySelector("span.me-2")) {
        authContainer.insertBefore(welcomeMessage, authContainer.firstChild);
      }
    } else {
      if (registerBtn) registerBtn.style.display = "inline-block";
      loginBtn =
        document.querySelector(".logout-btn") ||
        document.querySelector(".login-btn");
      if (loginBtn && loginBtn.classList.contains("logout-btn")) {
        loginBtn.textContent = "Login";
        loginBtn.classList.remove("logout-btn");
        loginBtn.classList.add("login-btn");
        const newLoginBtn = loginBtn.cloneNode(true);
        loginBtn.parentNode.replaceChild(newLoginBtn, loginBtn);
        loginBtn = newLoginBtn;
      }
      if (loginBtn) {
        loginBtn.addEventListener("click", () => {
          if (modalLogin) {
            modalLogin.classList.add("show");
            modalLogin.style.display = "flex";
          } else {
            Swal.fire(
              "Lỗi!",
              "Không tìm thấy modal đăng nhập. Vui lòng kiểm tra cấu trúc HTML.",
              "error"
            );
          }
        });
      }
      const welcomeMessage = document.querySelector(
        "header .d-flex.align-items-center span.me-2"
      );
      if (welcomeMessage) welcomeMessage.remove();
    }

    const newRegisterBtn = document.querySelector(".register-btn");
    if (newRegisterBtn) {
      newRegisterBtn.addEventListener("click", () => {
        if (modalRegister) {
          modalRegister.classList.add("show");
          modalRegister.style.display = "flex";
        } else {
          Swal.fire(
            "Lỗi!",
            "Không tìm thấy modal đăng ký. Vui lòng kiểm tra cấu trúc HTML.",
            "error"
          );
        }
      });
    }
  }

  // Xử lý modal đăng nhập
  if (modalLogin) {
    modalLogin.addEventListener("click", (e) => {
      if (e.target === modalLogin) {
        modalLogin.classList.remove("show");
        modalLogin.style.display = "none";
      }
    });
  }

  // Xử lý gửi form đăng nhập
  if (loginForm) {
    loginForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const email = document.getElementById("email")?.value.trim();
      const password = document.getElementById("password")?.value.trim();
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

      if (!emailRegex.test(email)) {
        Swal.fire("Lỗi!", "Vui lòng nhập địa chỉ email hợp lệ.", "error");
        return;
      }
      if (!password) {
        Swal.fire("Lỗi!", "Vui lòng nhập mật khẩu.", "error");
        return;
      }

      const user = accounts.find(
        (account) => account.email === email && account.password === password
      );

      if (user) {
        currentUser = user;
        Swal.fire("Thành công!", "Đăng nhập thành công.", "success").then(() => {
          modalLogin.classList.remove("show");
          modalLogin.style.display = "none";
          loginForm.reset();
          updateAuthButtons();
          if (user.role === "Admin") {
            window.location.href = "Admin-page.html";
          }
        });
      } else {
        Swal.fire("Lỗi!", "Email hoặc mật khẩu không đúng.", "error");
      }
    });
  }

  // Xử lý liên kết quên mật khẩu
  if (forgotPasswordLink) {
    forgotPasswordLink.addEventListener("click", (e) => {
      e.preventDefault();
      Swal.fire({
        title: "Quên mật khẩu",
        text: "Vui lòng liên hệ hỗ trợ tại shadowsgamer371@gmail.com để đặt lại mật khẩu.",
        icon: "info",
      });
    });
  }

  // Chuyển sang modal đăng ký từ modal đăng nhập
  if (registerLink) {
    registerLink.addEventListener("click", (e) => {
      e.preventDefault();
      modalLogin.classList.remove("show");
      modalLogin.style.display = "none";
      if (modalRegister) {
        modalRegister.classList.add("show");
        modalRegister.style.display = "flex";
      }
    });
  }

  // Xử lý modal đăng ký
  if (modalRegister) {
    modalRegister.addEventListener("click", (e) => {
      if (e.target === modalRegister) {
        modalRegister.classList.remove("show");
        modalRegister.style.display = "none";
      }
    });
  }

  // Xử lý gửi form đăng ký
  if (registerForm) {
    registerForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const name = document.getElementById("name")?.value.trim();
      const email = document.getElementById("email1")?.value.trim();
      const password1 = document.getElementById("password1")?.value.trim();
      const password2 = document.getElementById("password2")?.value.trim();
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      const passwordRegex =
        /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;

      if (!name || !email || !password1 || !password2) {
        Swal.fire("Lỗi!", "Vui lòng điền đầy đủ tất cả các trường.", "error");
        return;
      }
      if (!emailRegex.test(email)) {
        Swal.fire("Lỗi!", "Vui lòng nhập địa chỉ email hợp lệ.", "error");
        return;
      }
      if (!passwordRegex.test(password1)) {
        Swal.fire(
          "Lỗi!",
          "Mật khẩu phải dài ít nhất 8 ký tự, bao gồm chữ hoa, chữ thường, số và ký tự đặc biệt.",
          "error"
        );
        return;
      }
      if (password1 !== password2) {
        Swal.fire("Lỗi!", "Mật khẩu không khớp.", "error");
        return;
      }

      if (accounts.some((account) => account.email === email)) {
        Swal.fire("Lỗi!", "Email này đã được đăng ký.", "error");
        return;
      }

      const newAccount = {
        accountId: `TK${Math.floor(Math.random() * 1000000)
          .toString()
          .padStart(6, "0")}`,
        fullName: name,
        email,
        password: password1,
        dob: "",
        phone: "",
        hometown: "",
        role: "Users",
      };

      accounts.push(newAccount);
      currentUser = newAccount;

      Swal.fire(
        "Thành công!",
        "Đăng ký thành công. Bạn đã được đăng nhập.",
        "success"
      ).then(() => {
        modalRegister.classList.remove("show");
        modalRegister.style.display = "none";
        registerForm.reset();
        updateAuthButtons();
      });
    });
  }

  // Chuyển sang modal đăng nhập từ modal đăng ký
  if (loginLink) {
    loginLink.addEventListener("click", (e) => {
      e.preventDefault();
      modalRegister.classList.remove("show");
      modalRegister.style.display = "none";
      if (modalLogin) {
        modalLogin.classList.add("show");
        modalLogin.style.display = "flex";
      }
    });
  }

  // Chức năng thanh bên
  let isSidebarExpanded = false;
  if (chevronBtn && sidebar && mainContent && header) {
    chevronBtn.addEventListener("click", () => {
      isSidebarExpanded = !isSidebarExpanded;
      if (isSidebarExpanded) {
        sidebar.classList.add("expanded");
        mainContent.classList.add("expanded");
        header.classList.add("expanded");
        chevronBtn
          .querySelector("i")
          .classList.replace("fa-chevron-right", "fa-chevron-left");
      } else {
        sidebar.classList.remove("expanded");
        mainContent.classList.remove("expanded");
        header.classList.remove("expanded");
        chevronBtn
          .querySelector("i")
          .classList.replace("fa-chevron-left", "fa-chevron-right");
      }
    });
  }

  const links = document.querySelectorAll(".sidebar a");
  const currentPage = window.location.pathname.split("/").pop();
  links.forEach((link) => {
    const linkPage = link.getAttribute("href");
    if (linkPage === currentPage) {
      link.classList.add("active");
    }
  });

  // Chức năng trình phát âm thanh
  async function playSong(song, index, playlist, type) {
    if (!song || !song.mp3 || !song.image || !song.title || !song.artist) {
      console.error("Dữ liệu bài hát không hợp lệ:", song);
      Swal.fire("Lỗi!", "Dữ liệu bài hát không hợp lệ.", "error");
      return;
    }
    currentSongIndex = index;
    currentPlaylist = playlist;
    playlistType = type;
    if (playerAlbumImg && playerSongTitle && playerSongArtist && audioPlayer) {
      playerAlbumImg.src = song.image;
      playerSongTitle.textContent = song.title;
      playerSongArtist.textContent = song.artist;
      audioPlayer.src = song.mp3;

      audioPlayer.play().then(() => {
        isPlaying = true;
        if (playBtn) {
          playBtn.querySelector("i").classList.replace("bi-play-fill", "bi-pause-fill");
        }
      }).catch((error) => {
        console.error("Lỗi khi phát bài hát:", error);
        let errorMessage = "Không thể phát bài hát. Vui lòng kiểm tra kết nối mạng hoặc thử lại.";
        if (error.name === "NotAllowedError") {
          errorMessage = "Trình duyệt không cho phép tự động phát âm thanh. Vui lòng nhấp vào nút phát.";
        } else if (error.name === "NotSupportedError") {
          errorMessage = "Định dạng file âm thanh không được hỗ trợ.";
        }
        Swal.fire("Lỗi!", errorMessage, "error");
      });
    }
  }

  if (playBtn) {
    playBtn.addEventListener("click", () => {
      if (isPlaying) {
        audioPlayer.pause();
        isPlaying = false;
        playBtn.querySelector("i").classList.replace("bi-pause-fill", "bi-play-fill");
      } else {
        audioPlayer.play().then(() => {
          isPlaying = true;
          playBtn.querySelector("i").classList.replace("bi-play-fill", "bi-pause-fill");
        }).catch((error) => {
          console.error("Lỗi khi phát bài hát:", error);
          Swal.fire("Lỗi!", "Bạn chưa chọn bài hát. Vui lòng thử lại.", "error");
        });
      }
    });
  }

  if (skipBackwardBtn) {
    skipBackwardBtn.addEventListener("click", () => {
      if (currentSongIndex > 0) {
        playSong(
          currentPlaylist[currentSongIndex - 1],
          currentSongIndex - 1,
          currentPlaylist,
          playlistType
        );
      } else {
        Swal.fire("Thông báo", "Đây là bài hát đầu tiên trong danh sách.", "info");
      }
    });
  }

  if (skipForwardBtn) {
    skipForwardBtn.addEventListener("click", () => {
      if (currentSongIndex < currentPlaylist.length - 1) {
        playSong(
          currentPlaylist[currentSongIndex + 1],
          currentSongIndex + 1,
          currentPlaylist,
          playlistType
        );
      } else {
        Swal.fire("Thông báo", "Đây là bài hát cuối cùng trong danh sách.", "info");
      }
    });
  }

  if (muteBtn) {
    muteBtn.addEventListener("click", () => {
      isMuted = !isMuted;
      audioPlayer.muted = isMuted;
      muteBtn.querySelector("i").classList.toggle("bi-volume-up-fill", !isMuted);
      muteBtn.querySelector("i").classList.toggle("bi-volume-mute-fill", isMuted);
    });
  }

  const chartsContainer = document.querySelector(".charts-section");
  if (chartsContainer) {
    chartsContainer.addEventListener("click", async (e) => {
      const chartItem = e.target.closest(".chart-item");
      if (chartItem) {
        const indexAttr = chartItem.getAttribute("data-index");
        const index = indexAttr !== null ? parseInt(indexAttr, 10) : -1;

        if (
          !Number.isInteger(index) ||
          index < 0 ||
          index >= musicData.top15.length
        ) {
          console.error(
            "Chỉ số bài hát không hợp lệ hoặc bị thiếu data-index:",
            index,
            chartItem
          );
          Swal.fire("Lỗi!", "Không tìm thấy bài hát trong bảng xếp hạng.", "error");
          return;
        }

        const song = musicData.top15[index];
        if (song) {
          playSong(song, index, musicData.top15, "top15");
        } else {
          console.error("Không tìm thấy bài hát tại chỉ số:", index);
          Swal.fire("Lỗi!", "Không tìm thấy bài hát trong bảng xếp hạng.", "error");
        }
      }
    });
  }

  ["recently-played", "featured-artists", "featured-albums"].forEach((section) => {
    const container = document.querySelector(`.${section} .album-grid`);
    if (container) {
      container.addEventListener("click", async (e) => {
        const albumItem = e.target.closest(".album-item");
        if (albumItem) {
          const index = parseInt(albumItem.dataset.index, 10);
          if (
            isNaN(index) ||
            index < 0 ||
            index >= musicData.albums.length
          ) {
            console.error("Chỉ số album không hợp lệ:", index);
            Swal.fire("Lỗi!", "Không tìm thấy bài hát trong album.", "error");
            return;
          }
          const song = musicData.albums[index];
          if (song) {
            playSong(song, index, musicData.albums, "albums");
          } else {
            console.error("Không tìm thấy bài hát tại chỉ số album:", index);
            Swal.fire("Lỗi!", "Không tìm thấy bài hát trong album.", "error");
          }
        }
      });
    }
  });

  // Chức năng carousel
  const setupCarousel = (section) => {
    const grid = document.querySelector(`.${section} .album-grid`);
    const prevBtn = document.querySelector(
      `.${section} .carousel-controls button:first-child`
    );
    const nextBtn = document.querySelector(
      `.${section} .carousel-controls button:last-child`
    );

    if (grid && prevBtn && nextBtn) {
      let index = 0;
      const totalItems = grid.children.length;

      const getVisibleItems = () => {
        const gridWidth = grid.offsetWidth;
        const itemWidth = grid.children[0]?.offsetWidth || 1;
        return Math.floor(gridWidth / itemWidth);
      };

      nextBtn.addEventListener("click", () => {
        const visibleItems = getVisibleItems();
        if (index < totalItems - visibleItems) {
          index++;
          grid.style.transform = `translateX(-${index * (100 / visibleItems)}%)`;
        }
      });

      prevBtn.addEventListener("click", () => {
        if (index > 0) {
          index--;
          grid.style.transform = `translateX(-${index * (100 / getVisibleItems())}%)`;
        }
      });
    }
  };

  ["recently-played", "featured-artists", "featured-albums"].forEach(setupCarousel);

  // Khởi tạo giao diện
  updateAuthButtons();
  filterContent("");
});