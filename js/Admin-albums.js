let data = {
    "data": [
      {
        "Featured_Albums": [
          {
            "id": "1",
            "name": "Ava Cornish & Brian Hilltest",
            "name_music": "Bloodlust",
            "img": "/assets/album1.jpg.png",
            "mp3": "https://samplesongs.netlify.app/Death%20Bed.mp3"
          },
          {
            "id": "2",
            "name": "Ava Cornish & Brian Hill",
            "name_music": "Time flies",
            "img": "/assets/album2.jpg.png",
            "mp3": "https://samplesongs.netlify.app/Bad%20Liar.mp3"
          },
          {
            "id": "3",
            "name": "Ava Cornish & Brian Hilltest",
            "name_music": "Dark matters",
            "img": "/assets/album3.jpg.png",
            "mp3": "https://samplesongs.netlify.app/Faded.mp3"
          },
          {
            "id": "4",
            "name": "Ava Cornish & Brian Hilltest",
            "name_music": "Eye to eye",
            "img": "/assets/album4.jpg.png",
            "mp3": "https://samplesongs.netlify.app/Hate%20Me.mp3"
          },
          {
            "id": "5",
            "name": "Ava Cornish & Brian Hilltest",
            "name_music": "Cloud nine",
            "img": "/assets/album5.jpg.png",
            "mp3": "https://samplesongs.netlify.app/Solo.mp3"
          },
          {
            "id": "6",
            "name": "Ava Cornish & Brian Hilltest",
            "name_music": "Cobweb of lies",
            "img": "/assets/album6.jpg.png",
            "mp3": "https://samplesongs.netlify.app/Without%20Me.mp3"
          },
          {
            "id": "7",
            "name": "Ava Cornish & Brian Hilltest",
            "name_music": "Endless Things",
            "img": "/assets/artist1.jpg.png",
            "mp3": "https://samplesongs.netlify.app/Death%20Bed.mp3"
          },
          {
            "id": "8",
            "name": "Ava Cornish & Brian Hilltest",
            "name_music": "Desired Games",
            "img": "/assets/artist2.jpg.png",
            "mp3": "https://samplesongs.netlify.app/Death%20Bed.mp3"
          }
        ]
      },
      {
        "Trending_Albums": [
          {
            "id": "1",
            "name": "Ava Cornish & Brian Hilltest",
            "name_music": "Dream Your",
            "img": "/assets/artist13.jpg.png",
            "mp3": "https://samplesongs.netlify.app/Bad%20Liar.mp3"
          },
          {
            "id": "2",
            "name": "Ava Cornish & Brian Hill",
            "name_music": "Until I Met You",
            "img": "/assets/artist12.jpg.png",
            "mp3": "https://samplesongs.netlify.app/Faded.mp3"
          },
          {
            "id": "3",
            "name": "Ava Cornish & Brian Hilltest",
            "name_music": "Gimme Some Courage",
            "img": "/assets/artist11.jpg.png",
            "mp3": "https://samplesongs.netlify.app/Hate%20Me.mp3"
          },
          {
            "id": "4",
            "name": "Ava Cornish & Brian Hilltest",
            "name_music": "Dark Alley Acoustic",
            "img": "/assets/artist10.jpg.png",
            "mp3": "https://samplesongs.netlify.app/Hate%20Me.mp3"
          },
          {
            "id": "5",
            "name": "Ava Cornish & Brian Hilltest",
            "name_music": "Walking Promises",
            "img": "/assets/artist9.jpg.png",
            "mp3": "https://samplesongs.netlify.app/Death%20Bed.mp3"
          },
          {
            "id": "6",
            "name": "Ava Cornish & Brian Hilltest",
            "name_music": "Desired Games",
            "img": "/assets/artist8.jpg.png",
            "mp3": "https://samplesongs.netlify.app/Death%20Bed.mp3"
          },
          {
            "id": "7",
            "name": "Ava Cornish & Brian Hilltest",
            "name_music": "Endless Things",
            "img": "/assets/artist7.jpg.png",
            "mp3": "https://samplesongs.netlify.app/Solo.mp3"
          },
          {
            "id": "8",
            "name": "Ava Cornish & Brian Hilltest",
            "name_music": "Desired Games",
            "img": "/assets/artist6.jpg.png",
            "mp3": "https://samplesongs.netlify.app/Hate%20Me.mp3"
          }
        ]
      },
      {
        "top_15_albums": [
          {
            "id": "1",
            "name": "Ava Cornish & Brian Hilltest",
            "name_music": "Dream Your",
            "img": "/assets/1.png",
            "mp3": "https://samplesongs.netlify.app/Bad%20Liar.mp3"
          },
          {
            "id": "2",
            "name": "Ava Cornish & Brian Hilltest",
            "name_music": "Until I Met You",
            "img": "/assets/2.png",
            "mp3": "https://samplesongs.netlify.app/Solo.mp3"
          },
          {
            "id": "3",
            "name": "Ava Cornish & Brian Hilltest",
            "name_music": "Gimme Some",
            "img": "/assets/3.png",
            "mp3": "https://samplesongs.netlify.app/Hate%20Me.mp3"
          },
          {
            "id": "4",
            "name": "Ava Cornish & Brian Hilltest",
            "name_music": "Dark Alley Acoustic",
            "img": "/assets/4.png",
            "mp3": "https://samplesongs.netlify.app/Without%20Me.mp3"
          },
          {
            "id": "5",
            "name": "Ava Cornish & Brian Hilltest",
            "name_music": "Walking Promises",
            "img": "/assets/5.png",
            "mp3": "https://samplesongs.netlify.app/Solo.mp3"
          },
          {
            "id": "6",
            "name": "Ava Cornish & Brian Hilltest",
            "name_music": "Desired Games",
            "img": "/assets/6.png",
            "mp3": "https://samplesongs.netlify.app/Faded.mp3"
          },
          {
            "id": "7",
            "name": "Ava Cornish & Brian Hilltest",
            "name_music": "Endless Things",
            "img": "/assets/7.png",
            "mp3": "https://samplesongs.netlify.app/Solo.mp3"
          },
          {
            "id": "8",
            "name": "Ava Cornish & Brian Hilltest",
            "name_music": "Desired Games",
            "img": "/assets/8.png",
            "mp3": "https://samplesongs.netlify.app/Solo.mp3"
          },
          {
            "id": "9",
            "name": "Ava Cornish & Brian Hilltest",
            "name_music": "Desired Games",
            "img": "/assets/9.png",
            "mp3": "https://samplesongs.netlify.app/Solo.mp3"
          },
          {
            "id": "10",
            "name": "Ava Cornish & Brian Hilltest",
            "name_music": "Desired Games",
            "img": "/assets/10.png",
            "mp3": "https://samplesongs.netlify.app/Solo.mp3"
          },
          {
            "id": "11",
            "name": "Ava Cornish & Brian Hilltest",
            "name_music": "Desired Games",
            "img": "/assets/11.png",
            "mp3": "https://samplesongs.netlify.app/Solo.mp3"
          },
          {
            "id": "12",
            "name": "Ava Cornish & Brian Hilltest",
            "name_music": "Desired Games",
            "img": "/assets/12.png",
            "mp3": "https://samplesongs.netlify.app/Solo.mp3"
          },
          {
            "id": "13",
            "name": "Ava Cornish & Brian Hilltest",
            "name_music": "Desired Games",
            "img": "/assets/13.png",
            "mp3": "https://samplesongs.netlify.app/Solo.mp3"
          },
          {
            "id": "14",
            "name": "Ava Cornish & Brian Hilltest",
            "name_music": "Desired Games",
            "img": "/assets/14.png",
            "mp3": "https://samplesongs.netlify.app/Solo.mp3"
          },
          {
            "id": "15",
            "name": "Ava Cornish & Brian Hilltest",
            "name_music": "Desired Games",
            "img": "/assets/15.png",
            "mp3": "https://samplesongs.netlify.app/Solo.mp3"
          }
        ]
      },
      {
        "Albums_By_Artists": [
          {
            "id": "1",
            "name": "Ava Cornish",
            "name_music": "Best Of Ava Cornish",
            "img": "/assets/artist1.jpg.png",
            "mp3": "https://samplesongs.netlify.app/Solo.mp3"
          },
          {
            "id": "2",
            "name": "Until I Met You",
            "name_music": "Best Of Ava Cornish",
            "img": "/assets/artist2.jpg.png",
            "mp3": "/assets/2.mp3"
          },
          {
            "id": "3",
            "name": "Gimme Some Courage",
            "name_music": "Best Of Ava Cornish",
            "img": "/assets/artist3.jpg.png",
            "mp3": "/assets/3.mp3"
          },
          {
            "id": "4",
            "name": "Dark Alley Acoustic",
            "name_music": "Best Of Ava Cornish",
            "img": "/assets/artist4.jpg.png",
            "mp3": "/assets/4.mp3"
          },
          {
            "id": "5",
            "name": "Walking Promises",
            "name_music": "Best Of Ava Cornish",
            "img": "/assets/artist5.jpg.png",
            "mp3": "/assets/5.mp3"
          },
          {
            "id": "6",
            "name": "Desired Games",
            "name_music": "Best Of Ava Cornish",
            "img": "/assets/artist6.jpg.png",
            "mp3": "https://samplesongs.netlify.app/Solo.mp3"
          },
          {
            "id": "7",
            "name": "Endless Things",
            "name_music": "Best Of Ava Cornish",
            "img": "/assets/artist7.jpg.png",
            "mp3": "/assets/2.mp3"
          },
          {
            "id": "8",
            "name": "Desired Games",
            "name_music": "Best Of Ava Cornish",
            "img": "/assets/artist8.jpg.png",
            "mp3": "/assets/3.mp3"
          }
        ]
      },
      {
        "New_Releases": [
          {
            "id": "1",
            "name": "The Testers",
            "name_music": "Fresh Beats",
            "img": "/assets/artist6.jpg.png",
            "mp3": "https://samplesongs.netlify.app/Death%20Bed.mp3"
          },
          {
            "id": "2",
            "name": "Synthwave Masters",
            "name_music": "Neon Nights",
            "img": "/assets/artist1.jpg.png",
            "mp3": "https://samplesongs.netlify.app/Bad%20Liar.mp3"
          },
          {
            "id": "3",
            "name": "Indie Rockers",
            "name_music": "Garage Echoes",
            "img": "/assets/artist2.jpg.png",
            "mp3": "https://samplesongs.netlify.app/Faded.mp3"
          },
          {
            "id": "4",
            "name": "Chillhop Cafe",
            "name_music": "Lo-Fi Mornings",
            "img": "/assets/artist4.jpg.png",
            "mp3": "https://samplesongs.netlify.app/Hate%20Me.mp3"
          }
        ]
      }
    ]
};

let albums = JSON.parse(localStorage.getItem("albums")) || [];
let currentFilter = "all";
let currentPage = 1;
const itemsPerPage = 8;
let searchQuery = "";

// Kiểm tra xác thực người dùng
const currentUser = JSON.parse(localStorage.getItem("currentUser"));
if (!currentUser || currentUser.role !== "Admin") {
    Swal.fire({
        title: "Access Denied",
        text: "You do not have permission to access this page.",
        icon: "error",
        confirmButtonText: "OK"
    }).then(() => {
        window.location.href = "index.html";
    });
} else {
    // Tải dữ liệu từ localStorage hoặc dùng dữ liệu mặc định
    let albumsData = (() => {
        try {
            const stored = localStorage.getItem("albums");
            if (stored) {
                const parsed = JSON.parse(stored);
                if (parsed && Array.isArray(parsed.data)) {
                    return parsed;
                }
            }
            return data;
        } catch (e) {
            return data;
        }
    })();

    // Lưu dữ liệu vào localStorage
    function saveAlbums() {
        try {
            localStorage.setItem("albums", JSON.stringify(albumsData));
        } catch (e) {
            // Handle error silently
        }
    }

    // Làm phẳng dữ liệu để hiển thị (không lưu)
    function flattenAlbums() {
        if (!albumsData || !Array.isArray(albumsData.data)) {
            return [];
        }
        return albumsData.data.flatMap((category) => {
            const type = Object.keys(category)[0];
            return category[type].map((album, index) => ({
                ...album,
                type,
                originalCategory: type,
                originalIndex: index
            }));
        });
    }

    // Load and render albums
    function loadAlbums(filter = currentFilter, page = currentPage, query = searchQuery) {
        let filteredAlbums = filter === "all" ? flattenAlbums() : flattenAlbums().filter((a) => a.type === filter);

        if (query) {
            filteredAlbums = filteredAlbums.filter(
                (a) =>
                    a.name_music.toLowerCase().includes(query.toLowerCase()) ||
                    a.name.toLowerCase().includes(query.toLowerCase()) ||
                    a.id.toLowerCase().includes(query.toLowerCase())
            );
        }

        updateFilterCounts(flattenAlbums());
        const totalItems = filteredAlbums.length;
        const totalPages = Math.max(1, Math.ceil(totalItems / itemsPerPage));
        
        // Reset to page 1 if current page is greater than total pages
        if (page > totalPages) {
            page = 1;
            currentPage = 1;
        }
        
        const startIndex = (page - 1) * itemsPerPage;
        const paginatedAlbums = filteredAlbums.slice(startIndex, startIndex + itemsPerPage);

        const tbody = document.querySelector("table tbody");
        if (!tbody) {
            return;
        }
        tbody.innerHTML = paginatedAlbums.length
            ? paginatedAlbums
                .map(
                    (album) => `
                    <tr>
                        <td><div class="form-check"><input class="form-check-input" type="checkbox" value=""></div></td>
                        <td>${album.id}</td>
                        <td>${album.name_music}</td>
                        <td>${album.name}</td>
                        <td><img src="${album.img}" alt="${album.name_music}" style="width: 50px; height: 50px;"></td>
                        <td><a href="${album.mp3}" target="_blank">Link</a></td>
                        <td><span class="tag">${album.type}</span></td>
                        <td>
                            <div class="d-flex">
                                <button class="btn btn-sm btn-link text-danger p-0 me-2 delete-btn" data-category="${album.originalCategory}" data-index="${album.originalIndex}"><i class="bi bi-trash"></i></button>
                                <button class="btn btn-sm btn-link text-primary p-0 edit-btn" data-category="${album.originalCategory}" data-index="${album.originalIndex}"><i class="bi bi-pencil"></i></button>
                            </div>
                        </td>
                    </tr>
                `
                )
                .join("")
            : '<tr><td colspan="8" class="text-center">No albums found.</td></tr>';

        updatePagination(totalPages, page);
        attachButtonListeners();
    }

    // Update filter counts
    function updateFilterCounts(albums) {
        const counts = {
            all: albums.length,
            Featured_Albums: albums.filter((album) => album.type === "Featured_Albums").length,
            Trending_Albums: albums.filter((album) => album.type === "Trending_Albums").length,
            top_15_albums: albums.filter((album) => album.type === "top_15_albums").length,
            Albums_By_Artists: albums.filter((album) => album.type === "Albums_By_Artists").length,
        };

        Object.keys(counts).forEach(filter => {
            const pill = document.querySelector(`[data-filter="${filter}"] .filter-count`);
            if (pill) pill.textContent = counts[filter];
        });
    }

    // Update pagination
    function updatePagination(totalPages, currentPage) {
        const paginationContainer = document.querySelector(".pagination");
        if (!paginationContainer) {
            return;
        }
        paginationContainer.innerHTML = "";

        // Previous button
        const prevItem = document.createElement("li");
        prevItem.className = `page-item ${currentPage === 1 ? "disabled" : ""}`;
        prevItem.innerHTML = `<a class="page-link" href="#" aria-label="Previous"><i class="bi bi-chevron-left"></i></a>`;
        prevItem.addEventListener("click", (e) => {
            e.preventDefault();
            if (currentPage > 1) {
                loadAlbums(currentFilter, currentPage - 1, searchQuery);
            }
        });
        paginationContainer.appendChild(prevItem);

        // Page numbers
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
        if (endPage - startPage + 1 < maxVisiblePages) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }

        if (startPage > 1) {
            const firstPage = document.createElement("li");
            firstPage.className = "page-item";
            firstPage.innerHTML = `<a class="page-link" href="#">1</a>`;
            firstPage.addEventListener("click", (e) => {
                e.preventDefault();
                loadAlbums(currentFilter, 1, searchQuery);
            });
            paginationContainer.appendChild(firstPage);

            if (startPage > 2) {
                const ellipsis = document.createElement("li");
                ellipsis.className = "page-item disabled";
                ellipsis.innerHTML = `<span class="page-link">...</span>`;
                paginationContainer.appendChild(ellipsis);
            }
        }

        for (let i = startPage; i <= endPage; i++) {
            const pageItem = document.createElement("li");
            pageItem.className = `page-item ${i === currentPage ? "active" : ""}`;
            pageItem.innerHTML = `<a class="page-link" href="#">${i}</a>`;
            pageItem.addEventListener("click", (e) => {
                e.preventDefault();
                loadAlbums(currentFilter, i, searchQuery);
            });
            paginationContainer.appendChild(pageItem);
        }

        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                const ellipsis = document.createElement("li");
                ellipsis.className = "page-item disabled";
                ellipsis.innerHTML = `<span class="page-link">...</span>`;
                paginationContainer.appendChild(ellipsis);
            }

            const lastPage = document.createElement("li");
            lastPage.className = "page-item";
            lastPage.innerHTML = `<a class="page-link" href="#">${totalPages}</a>`;
            lastPage.addEventListener("click", (e) => {
                e.preventDefault();
                loadAlbums(currentFilter, totalPages, searchQuery);
            });
            paginationContainer.appendChild(lastPage);
        }

        // Next button
        const nextItem = document.createElement("li");
        nextItem.className = `page-item ${currentPage === totalPages ? "disabled" : ""}`;
        nextItem.innerHTML = `<a class="page-link" href="#" aria-label="Next"><i class="bi bi-chevron-right"></i></a>`;
        nextItem.addEventListener("click", (e) => {
            e.preventDefault();
            if (currentPage < totalPages) {
                loadAlbums(currentFilter, currentPage + 1, searchQuery);
            }
        });
        paginationContainer.appendChild(nextItem);
    }

    // Gắn sự kiện cho các nút
    function attachButtonListeners() {
        const deleteButtons = document.querySelectorAll(".delete-btn");
        const editButtons = document.querySelectorAll(".edit-btn");
        deleteButtons.forEach((btn) => {
            btn.removeEventListener("click", handleDelete);
            btn.addEventListener("click", handleDelete);
        });
        editButtons.forEach((btn) => {
            btn.removeEventListener("click", handleEdit);
            btn.addEventListener("click", handleEdit);
        });
    }

    // Xử lý thêm album
    const addButton = document.querySelector(".btn-primary");
    if (addButton) {
        addButton.addEventListener("click", () => {
            Swal.fire({
                title: "<strong>Add Album</strong>",
                html: `
                    <div class="container" style="text-align: left; font-family: Arial, sans-serif;">
                        <div class="row mb-2">
                            <div class="col-12">
                                <h6 style="color: #333; font-size: 14px; font-weight: bold;">Album Information</h6>
                                <p style="color: #666; font-size: 12px;">Add new album information</p>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-12 text-center">
                                <div class="d-flex justify-content-center align-items-center" style="height: 80px; width: 80px; border-radius: 50%; background-color: #e0e0e0; margin: 0 auto;">
                                    <span style="color: #666; font-size: 12px; text-align: center;">Click to upload</span>
                                </div>
                                <p style="color: #666; font-size: 10px; margin-top: 5px;">SVG, PNG, JPG or GIF (max. 400x400px)</p>
                                <input type="file" id="album-img" accept="image/*" style="display: none;" />
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-6">
                                <label class="form-label" style="color: #333; font-size: 12px;">Album Name</label>
                                <div class="input-group">
                                    <span class="input-group-text" style="background-color: #fff; border-right: none; border-color: #ccc;">
                                        <i class="bi bi-music-note-list" style="color: #666;"></i>
                                    </span>
                                    <input type="text" class="form-control" id="name_music" placeholder="Album Name" style="font-size: 12px; border-left: none; border-color: #ccc;" />
                                </div>
                            </div>
                            <div class="col-6">
                                <label class="form-label" style="color: #333; font-size: 12px;">Artist</label>
                                <div class="input-group">
                                    <span class="input-group-text" style="background-color: #fff; border-right: none; border-color: #ccc;">
                                        <i class="bi bi-person-fill" style="color: #666;"></i>
                                    </span>
                                    <input type="text" class="form-control" id="name" placeholder="Artist Name" style="font-size: 12px; border-left: none; border-color: #ccc;" />
                                </div>
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-6">
                                <label class="form-label" style="color: #333; font-size: 12px;">Image URL</label>
                                <div class="input-group">
                                    <span class="input-group-text" style="background-color: #fff; border-right: none; border-color: #ccc;">
                                        <i class="bi bi-image" style="color: #666;"></i>
                                    </span>
                                    <input type="text" class="form-control" id="img" placeholder="Image URL" style="font-size: 12px; border-left: none; border-color: #ccc;" />
                                </div>
                            </div>
                            <div class="col-6">
                                <label class="form-label" style="color: #333; font-size: 12px;">MP3 URL</label>
                                <div class="input-group">
                                    <span class="input-group-text" style="background-color: #fff; border-right: none; border-color: #ccc;">
                                        <i class="bi bi-music-note" style="color: #666;"></i>
                                    </span>
                                    <input type="text" class="form-control" id="mp3" placeholder="MP3 URL" style="font-size: 12px; border-left: none; border-color: #ccc;" />
                                </div>
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-6">
                                <label class="form-label" style="color: #333; font-size: 12px;">Type</label>
                                <select class="form-select" id="type" style="font-size: 12px; border-color: #ccc;">
                                    <option value="Featured_Albums">Featured</option>
                                    <option value="Trending_Albums">Trending</option>
                                    <option value="top_15_albums">Top 15</option>
                                    <option value="Albums_By_Artists">By Artists</option>
                                    <option value="New_Releases">New Releases</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `,
                showCloseButton: true,
                showCancelButton: true,
                focusConfirm: false,
                confirmButtonText: "Add Album",
                cancelButtonText: "Cancel",
                customClass: { popup: "custom-modal", confirmButton: "btn btn-primary", cancelButton: "btn btn-gray me-2" },
                didOpen: () => {
                    const uploadArea = document.querySelector(".d-flex.justify-content-center.align-items-center");
                    if (uploadArea) {
                        const fileInput = document.getElementById("album-img");
                        uploadArea.addEventListener("click", () => fileInput.click());
                    }
                },
                preConfirm: () => {
                    const name_music = document.getElementById("name_music").value.trim();
                    const name = document.getElementById("name").value.trim();
                    const img = document.getElementById("img").value.trim();
                    const mp3 = document.getElementById("mp3").value.trim();
                    const type = document.getElementById("type").value;

                    if (!name_music || !name || !img || !mp3) {
                        Swal.showValidationMessage("Tất cả các trường đều bắt buộc.");
                        return false;
                    }
                    

                    return { name_music, name, img, mp3, type };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const newAlbum = {
                        id: `${result.value.type.slice(0, 3).toUpperCase()}${Math.floor(Math.random() * 1000000).toString().padStart(6, "0")}`,
                        name_music: result.value.name_music,
                        name: result.value.name,
                        img: result.value.img,
                        mp3: result.value.mp3
                    };
                    const category = albumsData.data.find((cat) => cat[result.value.type]);
                    if (category) {
                        category[result.value.type].push(newAlbum);
                    } else {
                        albumsData.data.push({ [result.value.type]: [newAlbum] });
                    }
                    saveAlbums();
                    currentPage = 1;
                    loadAlbums();
                    Swal.fire("Success!", "Album added successfully.", "success");
                }
            });
        });
    } else {
        console.error("Không tìm thấy nút Thêm Album (.btn-primary)!");
    }

    // Xử lý xóa album
    function handleDelete(event) {
        const category = event.currentTarget.getAttribute("data-category");
        const index = parseInt(event.currentTarget.getAttribute("data-index"));
        const album = albumsData.data.find((cat) => cat[category])[category][index];

        Swal.fire({
            title: "<strong>Confirm Delete</strong>",
            html: `<p style="color: #333; font-size: 14px;">Are you sure you want to delete album <strong>${album.name_music}</strong>?</p>`,
            showCloseButton: true,
            showCancelButton: true,
            focusConfirm: false,
            confirmButtonText: "Delete",
            cancelButtonText: "Cancel",
            customClass: { popup: "custom-modal", confirmButton: "btn btn-danger", cancelButton: "btn btn-gray me-2" }
        }).then((result) => {
            if (result.isConfirmed) {
                albumsData.data.find((cat) => cat[category])[category].splice(index, 1);
                saveAlbums();
                currentPage = 1;
                loadAlbums();
                Swal.fire("Success!", "Album deleted successfully.", "success");
            }
        });
    }

    // Xử lý chỉnh sửa album
    function handleEdit(event) {
        const category = event.currentTarget.getAttribute("data-category");
        const index = parseInt(event.currentTarget.getAttribute("data-index"));
        const album = albumsData.data.find((cat) => cat[category])[category][index];

        Swal.fire({
            title: "<strong>Edit Album</strong>",
            html: `
                <div class="container" style="text-align: left; font-family: Arial, sans-serif;">
                    <div class="row mb-2">
                        <div class="col-12">
                            <h6 style="color: #333; font-size: 14px; font-weight: bold;">Album Information</h6>
                            <p style="color: #666; font-size: 12px;">Update album information</p>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-12 text-center">
                            <div class="d-flex justify-content-center align-items-center" style="height: 80px; width: 80px; border-radius: 50%; background-color: #e0e0e0; margin: 0 auto;">
                                <span style="color: #666; font-size: 12px; text-align: center;">Click to upload</span>
                            </div>
                            <p style="color: #666; font-size: 10px; margin-top: 5px;">SVG, PNG, JPG or GIF (max. 400x400px)</p>
                            <input type="file" id="album-img" accept="image/*" style="display: none;" />
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-6">
                            <label class="form-label" style="color: #333; font-size: 12px;">Album Name</label>
                            <div class="input-group">
                                <span class="input-group-text" style="background-color: #fff; border-right: none; border-color: #ccc;">
                                    <i class="bi bi-music-note-list" style="color: #666;"></i>
                                </span>
                                <input type="text" class="form-control" id="name_music" value="${album.name_music}" style="font-size: 12px; border-left: none; border-color: #ccc;" />
                            </div>
                        </div>
                        <div class="col-6">
                            <label class="form-label" style="color: #333; font-size: 12px;">Artist</label>
                            <div class="input-group">
                                <span class="input-group-text" style="background-color: #fff; border-right: none; border-color: #ccc;">
                                    <i class="bi bi-person-fill" style="color: #666;"></i>
                                </span>
                                <input type="text" class="form-control" id="name" value="${album.name}" style="font-size: 12px; border-left: none; border-color: #ccc;" />
                            </div>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-6">
                            <label class="form-label" style="color: #333; font-size: 12px;">Image URL</label>
                            <div class="input-group">
                                <span class="input-group-text" style="background-color: #fff; border-right: none; border-color: #ccc;">
                                    <i class="bi bi-image" style="color: #666;"></i>
                                </span>
                                <input type="text" class="form-control" id="img" value="${album.img}" style="font-size: 12px; border-left: none; border-color: #ccc;" />
                            </div>
                        </div>
                        <div class="col-6">
                            <label class="form-label" style="color: #333; font-size: 12px;">MP3 URL</label>
                            <div class="input-group">
                                <span class="input-group-text" style="background-color: #fff; border-right: none; border-color: #ccc;">
                                    <i class="bi bi-music-note" style="color: #666;"></i>
                                </span>
                                <input type="text" class="form-control" id="mp3" value="${album.mp3}" style="font-size: 12px; border-left: none; border-color: #ccc;" />
                            </div>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-6">
                            <label class="form-label" style="color: #333; font-size: 12px;">Type</label>
                            <select class="form-select" id="type" style="font-size: 12px; border-color: #ccc;">
                                <option value="Featured_Albums" ${album.type === "Featured_Albums" ? "selected" : ""}>Featured</option>
                                <option value="Trending_Albums" ${album.type === "Trending_Albums" ? "selected" : ""}>Trending</option>
                                <option value="top_15_albums" ${album.type === "top_15_albums" ? "selected" : ""}>Top 15</option>
                                <option value="Albums_By_Artists" ${album.type === "Albums_By_Artists" ? "selected" : ""}>By Artists</option>
                                <option value="New_Releases" ${album.type === "New_Releases" ? "selected" : ""}>New Releases</option>
                            </select>
                        </div>
                    </div>
                </div>
            `,
            showCloseButton: true,
            showCancelButton: true,
            focusConfirm: false,
            confirmButtonText: "Save",
            cancelButtonText: "Cancel",
            customClass: { popup: "custom-modal", confirmButton: "btn btn-primary", cancelButton: "btn btn-gray me-2" },
            didOpen: () => {
                const uploadArea = document.querySelector(".d-flex.justify-content-center.align-items-center");
                if (uploadArea) {
                    const fileInput = document.getElementById("album-img");
                    uploadArea.addEventListener("click", () => fileInput.click());
                }
            },
            preConfirm: () => {
                const name_music = document.getElementById("name_music").value.trim();
                const name = document.getElementById("name").value.trim();
                const img = document.getElementById("img").value.trim();
                const mp3 = document.getElementById("mp3").value.trim();
                const type = document.getElementById("type").value;

                if (!name_music || !name || !img || !mp3) {
                    Swal.showValidationMessage("Tất cả các trường đều bắt buộc.");
                    return false;
                }
                

                return { name_music, name, img, mp3, type };
            }
        }).then((result) => {
            if (result.isConfirmed) {
                const updatedAlbum = {
                    id: album.id,
                    name_music: result.value.name_music,
                    name: result.value.name,
                    img: result.value.img,
                    mp3: result.value.mp3
                };

                // If the type hasn't changed, just update the album in place
                if (result.value.type === category) {
                    albumsData.data.find((cat) => cat[category])[category][index] = updatedAlbum;
                } else {
                    // If the type has changed, remove from old category and add to new category
                    const oldCategory = albumsData.data.find((cat) => cat[category]);
                    oldCategory[category].splice(index, 1);
                    
                    const newCategory = albumsData.data.find((cat) => cat[result.value.type]) || {
                        [result.value.type]: []
                    };
                    if (!albumsData.data.includes(newCategory)) {
                        albumsData.data.push(newCategory);
                    }
                    newCategory[result.value.type].push(updatedAlbum);
                }

                saveAlbums();
                loadAlbums(currentFilter, currentPage, searchQuery);
                Swal.fire("Success!", "Album updated successfully.", "success");
            }
        });
    }

    // Bộ lọc và tìm kiếm
    const filterPills = document.querySelectorAll(".filter-pill");
    if (filterPills.length) {
        filterPills.forEach((pill) => {
            pill.addEventListener("click", () => {
                filterPills.forEach((p) => p.classList.remove("active"));
                pill.classList.add("active");
                currentFilter = pill.getAttribute("data-filter");
                currentPage = 1;
                loadAlbums();
            });
        });
    }

    const searchInput = document.querySelector(".form-control[placeholder='Tìm kiếm']");
    if (searchInput) {
        searchInput.addEventListener("input", (e) => {
            searchQuery = e.target.value.trim();
            currentPage = 1;
            loadAlbums();
        });
    }

    // Đăng xuất
    const logoutBtn = document.querySelector(".logout-btn");
    if (logoutBtn) {
        logoutBtn.addEventListener("click", () => {
            localStorage.removeItem("currentUser");
            Swal.fire("Thành công", "Đã đăng xuất thành công.", "success").then(() => {
                window.location.href = "index.html";
            });
        });
    }

    // Xóa các album đã chọn
    const deleteSelectedBtn = document.querySelector(".delete-selected-btn");
    if (deleteSelectedBtn) {
        deleteSelectedBtn.addEventListener("click", () => {
            const checkboxes = document.querySelectorAll("tbody .form-check-input:checked");
            if (checkboxes.length === 0) {
                Swal.fire("Warning", "Please select at least one album.", "warning");
                return;
            }

            Swal.fire({
                title: "Confirm Delete",
                text: `Are you sure you want to delete ${checkboxes.length} selected albums?`,
                showCancelButton: true,
                confirmButtonText: "Delete",
                cancelButtonText: "Cancel",
                customClass: { popup: "custom-modal", confirmButton: "btn btn-danger", cancelButton: "btn btn-gray me-2" }
            }).then((result) => {
                if (result.isConfirmed) {
                    const deletions = Array.from(checkboxes)
                        .map((cb) => {
                            const deleteBtn = cb.closest("tr").querySelector(".delete-btn");
                            return deleteBtn
                                ? {
                                      category: deleteBtn.getAttribute("data-category"),
                                      index: parseInt(deleteBtn.getAttribute("data-index"))
                                  }
                                : null;
                        })
                        .filter((del) => del !== null);

                    deletions.sort((a, b) => b.index - a.index);
                    deletions.forEach(({ category, index }) => {
                        albumsData.data.find((cat) => cat[category])[category].splice(index, 1);
                    });

                    saveAlbums();
                    currentPage = 1;
                    loadAlbums();
                    Swal.fire("Success", "Selected albums deleted.", "success");
                }
            });
        });
    }

    // Chọn tất cả
    const selectAllCheckbox = document.getElementById("selectAll");
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener("change", (e) => {
            const checkboxes = document.querySelectorAll("tbody .form-check-input");
            checkboxes.forEach((cb) => (cb.checked = e.target.checked));
        });
    }

    // Initial load
    loadAlbums();
}